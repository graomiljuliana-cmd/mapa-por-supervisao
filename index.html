<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa por Supervis√£o</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
        font-family: Arial, sans-serif;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    /* Legenda Desktop */
    #legend {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 14px;
        border-radius: 8px;
        z-index: 9999;
        max-height: 70vh;
        overflow-y: auto;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        font-size: 14px;
    }

    /* Bot√£o para abrir legenda no celular */
    #legend-toggle {
        display: none;
        position: fixed;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: #2c3e50;
        color: #fff;
        border: none;
        padding: 12px 18px;
        border-radius: 26px;
        font-size: 17px;
        z-index: 99999;
    }

    /* Painel mobile */
    #legend-mobile {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 20px;
        max-height: 60%;
        overflow-y: auto;
        border-radius: 20px 20px 0 0;
        box-shadow: 0px -6px 14px rgba(0,0,0,0.25);
        z-index: 99990;
        font-size: 14px;
    }

    /* Modo celular */
    @media (max-width: 768px) {
        #legend { display: none !important; }
        #legend-toggle { display: block !important; }
    }
</style>

</head>
<body>

<div id="map"></div>

<!-- Legenda Desktop -->
<div id="legend"></div>

<!-- Bot√£o Mobile -->
<button id="legend-toggle">Legenda ‚Üë</button>

<!-- Painel Mobile -->
<div id="legend-mobile">
    <h3>Legenda</h3>
    <div id="legend-content-mobile"></div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ====================== CONFIG ============================

// üî¥ IMPORTANTE: sem o "S" no come√ßo
const DATA_URL = "https://script.google.com/macros/s/AKfycbwCygprEX86NlhN3bmzWx4mBWgCEK9uOceNzyWlx_JL34vTgu9uTyat_k6kMsnp5SW4rw/exec";

// GeoJSON dos munic√≠pios (no mesmo reposit√≥rio do GitHub)
const MUNICIPIOS_URL = "municipios-br.geojson";

// Paleta fixa de cores para supervis√µes (usa nome NORMALIZADO: BAHIA, MT1 etc.)
function getColorForSupervisao(nome) {
    const colors = [
        "#e6194B", "#3cb44b", "#ffe119", "#4363d8", "#f58231",
        "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#fabebe",
        "#008080", "#e6beff", "#9A6324", "#fffac8", "#800000",
        "#aaffc3", "#808000", "#ffd8b1", "#000075", "#808080"
    ];
    let hash = 0;
    for (let i = 0; i < nome.length; i++) {
        hash = nome.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}

// Mesma normaliza√ß√£o do Apps Script (normalizarIBGE)
function normalizarIBGEFront(txt) {
    if (!txt) return "";
    return String(txt)
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^A-Za-z0-9 ]/g, " ")
        .replace(/\s+/g, " ")
        .trim()
        .toUpperCase();
}

// ====================== MAPA ============================
const map = L.map('map').setView([-15.8, -47.9], 5);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18
}).addTo(map);

// Camadas por supervis√£o
let supervisaoLayers = {};

// ====================== CARREGAR DADOS ============================
async function carregarDados() {
    try {
        const pontosResp = await fetch(DATA_URL);
        const pontos = await pontosResp.json(); // [{cidade, uf, supervisao, lat, lng}, ...]

        // Se vier erro do Apps Script, mostra no console
        if (!Array.isArray(pontos)) {
            console.error("Resposta do Apps Script:", pontos);
            alert("Erro ao carregar dados da planilha. Veja o console.");
            return;
        }

        const municipiosResp = await fetch(MUNICIPIOS_URL);
        const municipios = await municipiosResp.json();

        const legendDiv = document.getElementById("legend");
        legendDiv.innerHTML = "<h3>Supervis√µes</h3>";

        // Criar layer e legenda para cada supervis√£o encontrada
        pontos.forEach(p => {
            const sup = p.supervisao; // j√° vem NORMALIZADO do Apps Script
            const cor = getColorForSupervisao(sup);

            if (!supervisaoLayers[sup]) {
                supervisaoLayers[sup] = L.layerGroup().addTo(map);

                legendDiv.innerHTML += `
                    <div style="margin-bottom:6px">
                        <span style="background:${cor};width:14px;height:14px;display:inline-block;margin-right:6px;border-radius:3px;"></span>
                        ${sup}
                    </div>
                `;
            }
        });

        // Pintar pol√≠gonos de munic√≠pios
        municipios.features.forEach(f => {
            const cidadeGeo = normalizarIBGEFront(f.properties.name);
            const ufGeo     = normalizarIBGEFront(f.properties.uf);

            const match = pontos.find(p =>
                p.cidade === cidadeGeo &&
                p.uf === ufGeo
            );

            if (match) {
                const sup = match.supervisao;
                const cor = getColorForSupervisao(sup);

                const poly = L.geoJSON(f, {
                    style: {
                        color: cor,
                        weight: 2,
                        fillColor: cor,
                        fillOpacity: 0.35
                    }
                });

                poly.addTo(supervisaoLayers[sup]);
                poly.bindPopup(`
                    <b>${cidadeGeo} - ${ufGeo}</b><br>
                    <b>Supervis√£o:</b> ${sup}
                `);
            }
        });

        copiarLegendaParaMobile();
    } catch (e) {
        console.error("Erro em carregarDados:", e);
        alert("Erro ao montar o mapa. Veja o console do navegador.");
    }
}

carregarDados();

// ================= MOBILE LEGEND ======================
function copiarLegendaParaMobile() {
    document.getElementById("legend-content-mobile").innerHTML =
        document.getElementById("legend").innerHTML;
}

const btn = document.getElementById("legend-toggle");
const panel = document.getElementById("legend-mobile");
let aberto = false;

btn.addEventListener("click", () => {
    aberto = !aberto;
    panel.style.display = aberto ? "block" : "none";
    btn.textContent = aberto ? "Fechar ‚Üì" : "Legenda ‚Üë";
});
</script>

</body>
</html>
